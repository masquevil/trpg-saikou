<script setup lang="ts">
import { ref, computed, watch } from 'vue';

// components
import PaperSection from '@/components/coc-card/PaperSection.vue';
import WritableRow from '@/components/coc-card/WritableRow.vue';
import FlattenTree from '@/components/coc-card/FlattenTree.vue';

// models
import formattedJobs from '@/models/coc-card/job';

import vClickOutside from '@/directives/clickOutside';
import usePC from '@/hooks/usePC';

import type { FlattenTreeData } from '@/types/coc-card/flattenTree';

const pc = usePC();

const { jobGroups } = formattedJobs;

const isJobSeletorShowing = ref(false);
const jobSearchInput = ref('');

function openJobSelector() {
  isJobSeletorShowing.value = true;
}
function closeJobSelector() {
  isJobSeletorShowing.value = false;
}
watch(
  () => isJobSeletorShowing.value,
  () => {
    jobSearchInput.value = '';
  }
);

const jobTree = computed(() => {
  const filterText = jobSearchInput.value;
  const filteredData = jobGroups.reduce((result, jobGroup) => {
    const { name: groupName, pinyin: groupPinyin, jobs } = jobGroup;
    const filteredChildren = jobs.reduce((result, job) => {
      if (
        !filterText ||
        groupName.includes(filterText) ||
        groupPinyin.includes(filterText) ||
        job.name.includes(filterText) ||
        job.pinyin.includes(filterText)
      ) {
        result.push({ label: job.name, key: job.name });
      }
      return result;
    }, [] as { label: string; key: string }[]);
    if (filteredChildren.length) {
      result.push({
        label: groupName,
        key: groupName,
        children: filteredChildren,
      });
    }
    return result;
  }, [] as FlattenTreeData);
  return filteredData;
});

function onSelectJob(jobName: string) {
  if (!pc) return;
  pc.value.job = jobName;
  closeJobSelector();
}
</script>

<template>
  <PaperSection
    title="调查员"
    subTitle="Investigator"
    v-if="pc"
  >
    <div class="info-section">
      <WritableRow
        label="姓名"
        v-model="pc.name"
      />
      <WritableRow
        label="玩家"
        v-model="pc.playerName"
      />
      <WritableRow
        label="时代"
        v-model="pc.time"
      />
      <div
        class="rel"
        v-click-outside="closeJobSelector"
      >
        <WritableRow
          label="职业"
          v-model="pc.job"
          placeholder="自定义职业或选择预设职业"
          @focus="openJobSelector"
        />
        <Transition name="slide-up">
          <div
            v-if="isJobSeletorShowing"
            class="job-selector"
          >
            <div class="job-selector-header">
              <input
                class="job-search-input"
                type="text"
                placeholder="输入职业名称或拼音可以进行搜索"
                v-model="jobSearchInput"
              />
            </div>
            <FlattenTree
              :tree="jobTree"
              @select="(item) => onSelectJob(item.label)"
            />
          </div>
        </Transition>
      </div>
      <div class="row">
        <WritableRow
          label="年龄"
          v-model="pc.age"
        />
        <WritableRow
          label="性别"
          v-model="pc.gender"
        />
      </div>
      <div class="row">
        <WritableRow
          label="住地"
          v-model="pc.location"
        />
        <WritableRow
          label="故乡"
          v-model="pc.hometown"
        />
      </div>
    </div>
  </PaperSection>
</template>

<style scoped lang="scss">
.row {
  display: flex;
  gap: 1em;
}

.info-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 0.2em;
  padding: 0.4em 0.6em 0.6em;
}

.job-selector {
  position: absolute;
  width: calc(65.625em - 2em); // 210mm - 2em
  left: -1.6em;
  margin-top: 1em;
  border: 1px solid #777;
  padding: 1em;
  background-color: #fff;
  z-index: 1;
}

.job-selector-header {
  padding-bottom: 1em;
  margin-bottom: 1em;
  border-bottom: 1px solid var(--color-border);
}
.job-search-input {
  border: 1px solid var(--color-border);
  width: 100%;
  padding: 0.6em 0.8em;
}

@media print {
  .job-selector {
    display: none;
  }
}
</style>
